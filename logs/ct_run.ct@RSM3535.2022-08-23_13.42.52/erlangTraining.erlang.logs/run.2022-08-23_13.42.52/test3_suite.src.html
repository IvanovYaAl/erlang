<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/home/iaroslav/GitLabs/erlangTraining/erlang/test3_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <b>-module</b>(test3_SUITE).
<a name="2"/>    2: <b>-compile</b>(export_all).
<a name="3"/>    3: 
<a name="4"/>    4: <b>-include_lib</b>(&quot;eunit/include/eunit.hrl&quot;).
<a name="5"/>    5: 
<a name="all-0"/><a name="6"/>    6: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="7"/>    7:   [
<a name="8"/>    8:     db_list_test,
<a name="9"/>    9:     db_ets_test,
<a name="10"/>   10:     lr_test,
<a name="11"/>   11: <i>%% NOTE: The test below should be run manually to check the correctness of BS behaviour</i>
<a name="12"/>   12:     bs_test
<a name="13"/>   13:   ].
<a name="14"/>   14: 
<a name="log_start-1"/><a name="log_start-last_expr"/><a name="15"/>   15: <b>log_start</b>(FuncName)  -&gt; ct:print(&quot;========== Start ~p ==========&quot;, [FuncName]).
<a name="log_finish-1"/><a name="log_finish-last_expr"/><a name="16"/>   16: <b>log_finish</b>(FuncName) -&gt; ct:print(&quot;========== Finish ~p ==========&quot;, [FuncName]).
<a name="17"/>   17: 
<a name="db_list_test-1"/><a name="18"/>   18: <b>db_list_test</b>(_) -&gt;
<a name="19"/>   19:   log_start(?FUNCTION_NAME),
<a name="20"/>   20:   backend_test(db_list),
<a name="21"/>   21:   backend_dup_test(db_list),
<a name="db_list_test-last_expr"/><a name="22"/>   22: <b>  log_finish</b>(?FUNCTION_NAME).
<a name="23"/>   23: 
<a name="db_ets_test-1"/><a name="24"/>   24: <b>db_ets_test</b>(_) -&gt;
<a name="25"/>   25:   log_start(?FUNCTION_NAME),
<a name="26"/>   26:   backend_test(db_ets),
<a name="27"/>   27:   backend_dup_test(db_ets),
<a name="db_ets_test-last_expr"/><a name="28"/>   28: <b>  log_finish</b>(?FUNCTION_NAME).
<a name="29"/>   29: 
<a name="backend_test-1"/><a name="30"/>   30: <b>backend_test</b>(Module) -&gt;
<a name="31"/>   31:   ct:print(&quot;Init DB&quot;, []),
<a name="32"/>   32:   {ok, D1} = Module:db_init(),
<a name="33"/>   33: 
<a name="34"/>   34:   ct:print(&quot;Put to DB&quot;, []),
<a name="35"/>   35:   {ok, D2} = Module:db_put(key, data, D1),
<a name="36"/>   36:   {ok, D3} = Module:db_put(key2, data, D2),
<a name="37"/>   37:   {ok, D4} = Module:db_put(key3, [1, 2, 3], D3),
<a name="38"/>   38: 
<a name="39"/>   39:   ct:print(&quot;Get from DB&quot;, []),
<a name="40"/>   40:   {ok, data} = Module:db_get(key, D4),
<a name="41"/>   41:   {ok, data} = Module:db_get(key2, D4),
<a name="42"/>   42:   {ok, [1,2,3]} = Module:db_get(key3, D4),
<a name="43"/>   43: 
<a name="44"/>   44:   ct:print(&quot;Query data from DB&quot;, []),
<a name="45"/>   45:   {ok, Query} = Module:db_query(data, D4),
<a name="46"/>   46:   ?assertEqual(2, length(Query)),
<a name="47"/>   47:   ?assert(lists:member(key, Query)),
<a name="48"/>   48:   ?assert(lists:member(key2, Query)),
<a name="49"/>   49: 
<a name="50"/>   50:   ct:print(&quot;Delete from DB&quot;, []),
<a name="51"/>   51:   {ok, D5} = Module:db_delete(key, D4),
<a name="52"/>   52: 
<a name="53"/>   53:   ct:print(&quot;Get unexisted key from DB&quot;, []),
<a name="54"/>   54:   undefined = Module:db_get(key, D5),
<a name="55"/>   55: 
<a name="56"/>   56:   ct:print(&quot;Query unexisted data from DB&quot;, []),
<a name="57"/>   57:   undefined = Module:db_query(unknown_data, D5),
<a name="58"/>   58: 
<a name="59"/>   59:   ct:print(&quot;Empty DB&quot;, []),
<a name="60"/>   60:   {ok, D6} = Module:db_empty(D5),
<a name="61"/>   61:   undefined = Module:db_get(key, D6),
<a name="62"/>   62:   undefined = Module:db_get(key2, D6),
<a name="63"/>   63:   undefined = Module:db_get(key3, D6),
<a name="64"/>   64: 
<a name="65"/>   65:   ct:print(&quot;Close DB&quot;, []),
<a name="backend_test-last_expr"/><a name="66"/>   66: <b>  ok = Module:db_close</b>(D6).
<a name="67"/>   67: 
<a name="backend_dup_test-1"/><a name="68"/>   68: <b>backend_dup_test</b>(Module) -&gt;
<a name="69"/>   69:   OldData = data,
<a name="70"/>   70:   {ok, D1} = Module:db_init(),
<a name="71"/>   71:   {ok, D2} = Module:db_put(key, OldData, D1),
<a name="72"/>   72:   ct:print(&quot;Put data with the same key to DB&quot;, []),
<a name="73"/>   73:   {ok, D3} = Module:db_put(key, newdata, D2),
<a name="74"/>   74:   {ok, Data} = Module:db_get(key, D3),
<a name="75"/>   75:   ct:print(&quot;Data is changed from ~p to ~p&quot;, [OldData, Data]),
<a name="76"/>   76:   {ok, _} = Module:db_empty(D3),
<a name="backend_dup_test-last_expr"/><a name="77"/>   77: <b>  ok = Module:db_close</b>(D3).
<a name="78"/>   78: 
<a name="lr_test-1"/><a name="79"/>   79: <b>lr_test</b>(_) -&gt;
<a name="80"/>   80:   log_start(?FUNCTION_NAME),
<a name="81"/>   81: 
<a name="82"/>   82:   ct:print(&quot;Start LR&quot;, []),
<a name="83"/>   83:   {ok, _Pid} = lr:start_link(),
<a name="84"/>   84: 
<a name="85"/>   85:   ct:print(&quot;Where is unknown MS?&quot;, []),
<a name="86"/>   86:   ?assertEqual(lost, lr:where_is(unknown_ms)),
<a name="87"/>   87: 
<a name="88"/>   88:   ct:print(&quot;Who are at unknown BS?&quot;, []),
<a name="89"/>   89:   ?assertEqual(none, lr:who_are_at(unknown_bs)),
<a name="90"/>   90: 
<a name="91"/>   91:   ct:print(&quot;Locate some MS to some BS&quot;, []),
<a name="92"/>   92:   ?assertEqual(ok, lr:located_at(ms1, bs1)),
<a name="93"/>   93:   ?assertEqual(ok, lr:located_at(ms2, bs2)),
<a name="94"/>   94:   ?assertEqual(ok, lr:located_at(ms3, bs1)),
<a name="95"/>   95:   ?assertEqual(ok, lr:located_at(ms4, bs2)),
<a name="96"/>   96: 
<a name="97"/>   97:   ct:print(&quot;Locate duplicated MS&quot;, []),
<a name="98"/>   98:   ?assertEqual(ok, lr:located_at(ms4, bs2)),
<a name="99"/>   99: 
<a name="100"/>  100:   ct:print(&quot;Where is MS?&quot;, []),
<a name="101"/>  101:   ?assertEqual({ok, bs1}, lr:where_is(ms1)),
<a name="102"/>  102:   ?assertEqual({ok, bs2}, lr:where_is(ms2)),
<a name="103"/>  103:   ?assertEqual({ok, bs1}, lr:where_is(ms3)),
<a name="104"/>  104:   ?assertEqual({ok, bs2}, lr:where_is(ms4)),
<a name="105"/>  105: 
<a name="106"/>  106:   ct:print(&quot;Who are at BS?&quot;, []),
<a name="107"/>  107:   {ok, AtBs1} = lr:who_are_at(bs1),
<a name="108"/>  108:   {ok, AtBs2} = lr:who_are_at(bs2),
<a name="109"/>  109:   ?assert(lists:member(ms1, AtBs1)),
<a name="110"/>  110:   ?assert(lists:member(ms3, AtBs1)),
<a name="111"/>  111:   ?assert(lists:member(ms2, AtBs2)),
<a name="112"/>  112:   ?assert(lists:member(ms4, AtBs2)),
<a name="113"/>  113:   ?assertEqual(2, length(AtBs1)),
<a name="114"/>  114:   ?assertEqual(2, length(AtBs2)),
<a name="115"/>  115: 
<a name="116"/>  116:   ct:print(&quot;Lost MS&quot;, []),
<a name="117"/>  117:   ?assertEqual(ok, lr:lost(ms1)),
<a name="118"/>  118:   ?assertEqual(ok, lr:lost(ms1)),
<a name="119"/>  119:   ?assertEqual(lost, lr:where_is(ms1)),
<a name="120"/>  120:   ?assertEqual({ok, [ms3]}, lr:who_are_at(bs1)),
<a name="121"/>  121: 
<a name="122"/>  122:   ?assertEqual(ok, lr:lost(ms2)),
<a name="123"/>  123:   ?assertEqual(lost, lr:where_is(ms2)),
<a name="124"/>  124:   ?assertEqual({ok, [ms4]}, lr:who_are_at(bs2)),
<a name="125"/>  125: 
<a name="126"/>  126:   ct:print(&quot;Empty LR&quot;, []),
<a name="127"/>  127:   ?assertEqual(ok, lr:empty()),
<a name="128"/>  128:   ?assertEqual(lost, lr:where_is(ms3)),
<a name="129"/>  129:   ?assertEqual(lost, lr:where_is(ms4)),
<a name="130"/>  130:   ?assertEqual(none, lr:who_are_at(bs1)),
<a name="131"/>  131:   ?assertEqual(none, lr:who_are_at(bs2)),
<a name="132"/>  132: 
<a name="133"/>  133:   ct:print(&quot;Stop LR&quot;, []),
<a name="134"/>  134:   ?assertEqual(ok, lr:stop()),
<a name="135"/>  135: 
<a name="lr_test-last_expr"/><a name="136"/>  136: <b>  log_finish</b>(?FUNCTION_NAME).
<a name="137"/>  137: 
<a name="bs_test-1"/><a name="138"/>  138: <b>bs_test</b>(_) -&gt;
<a name="139"/>  139:   log_start(?FUNCTION_NAME),
<a name="140"/>  140: 
<a name="141"/>  141:   ct:print(&quot;Start BS &amp; LR&quot;, []),
<a name="142"/>  142:   lr:start_link(),
<a name="143"/>  143:   {ok, BsPid} = bs:start_link(bs1),
<a name="144"/>  144:   sys:trace(BsPid, true),
<a name="145"/>  145: 
<a name="146"/>  146:   ct:print(&quot;Start several MS&quot;, []),
<a name="147"/>  147:   ms:start (ms1, BsPid),
<a name="148"/>  148:   ms:start (ms2, BsPid),
<a name="149"/>  149:   timer:sleep(5000),
<a name="150"/>  150: 
<a name="151"/>  151:   ct:print(&quot;Stop BS&quot;, []),
<a name="152"/>  152:   ?assertEqual(ok, bs:stop(BsPid)),
<a name="153"/>  153:   timer:sleep(5000),
<a name="154"/>  154: 
<a name="bs_test-last_expr"/><a name="155"/>  155: <b>  log_finish</b>(?FUNCTION_NAME).
</pre>
</body>
</html>
